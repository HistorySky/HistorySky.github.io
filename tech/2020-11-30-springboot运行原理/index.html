<!doctype html><html lang=zh-CN data-theme=dark><head><meta charset=utf-8><meta name=viewport content="width=device-width"><meta name=theme-color content="#222" media="(prefers-color-scheme: dark)"><meta name=generator content="Hugo 0.114.1"><link rel="shortcut icon" type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/png sizes=16x16 href=/imgs/icons/favicon_16x16_next.png><link rel=icon type=image/png sizes=32x32 href=/imgs/icons/favicon_32_32_next.png><link rel=apple-touch-icon sizes=180x180 href=/imgs/icons/apple_touch_icon_next.png><meta itemprop=name content="Spring Boot运行原理"><meta itemprop=description content="知识改变自己"><meta itemprop=datePublished zgotmplz><meta itemprop=dateModified zgotmplz><meta itemprop=image content="https://historysky.github.io/images/head_%E4%B8%A4%E5%8F%AA%E7%8C%AB.png"><meta itemprop=keywords content="这是一个keywords"><meta property="og:type" content="article"><meta property="og:title" content="Spring Boot运行原理"><meta property="og:description" content="知识改变自己"><meta property="og:image" content="/images/head_两只猫.png"><meta property="og:image:width" content="312"><meta property="og:image:height" content="312"><meta property="og:image:type" content="image/jpeg/png/svg/jpg"><meta property="og:url" content="https://historysky.github.io/tech/2020-11-30-springboot%E8%BF%90%E8%A1%8C%E5%8E%9F%E7%90%86/"><meta property="og:site_name" content="半缘的小阁楼"><meta property="og:locale" content="zh-CN"><meta property="article:author" content="孤言"><meta property="article:published_time" content="2020-09-27 20:18:54 +0300 +0300"><meta property="article:modified_time" content="2020-09-27 20:18:54 +0300 +0300"><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/font-awesome/6.1.2/css/all.min.css><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/animate.css/3.1.1/animate.min.css><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/viewerjs/1.11.0/viewer.min.css><link rel=stylesheet href=/css/main.min.70c7aca2940fdd6d694ab752b3a5d18be3dffdbea29bf478e84f94cd707c5097.css><script type=text/javascript>(function(){localDB={set:function(e,t,n){if(n===0)return;const s=new Date,o=n*864e5,i={value:t,expiry:s.getTime()+o};localStorage.setItem(e,JSON.stringify(i))},get:function(e){const t=localStorage.getItem(e);if(!t)return void 0;const n=JSON.parse(t),s=new Date;return s.getTime()>n.expiry?(localStorage.removeItem(e),void 0):n.value}},theme={active:function(){const e=localDB.get("theme");if(e==null)return;theme.toggle(e),window.matchMedia("(prefers-color-scheme: dark)").addListener(function(e){theme.toggle(e.matches?"dark":"light")})},toggle:function(e){document.documentElement.setAttribute("data-theme",e),localDB.set("theme",e,2);const t=document.querySelector("iframe.giscus-frame");if(t){const n={setConfig:{theme:e}};t.contentWindow.postMessage({giscus:n},"https://giscus.app")}}},theme.active()})(window)</script><script class=next-config data-name=page type=application/json>{"comments":false,"isHome":false,"isPage":true,"path":"2020-11-30-springboot%E8%BF%90%E8%A1%8C%E5%8E%9F%E7%90%86","permalink":"https://historysky.github.io/tech/2020-11-30-springboot%E8%BF%90%E8%A1%8C%E5%8E%9F%E7%90%86/","title":"Spring Boot运行原理","waline":{"js":[{"alias":"waline","alias_name":"@waline/client","file":"dist/pageview.js","name":"pageview","version":"2.13.0"},{"alias":"waline","alias_name":"@waline/client","file":"dist/comment.js","name":"comment","version":"2.13.0"}]}}</script><script type=text/javascript>document.addEventListener("DOMContentLoaded",()=>{var e=document.createElement("script");e.charset="UTF-8",e.src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js",e.async=!1,e.defer=!0,document.head.appendChild(e),e.onload=function(){NexT.utils.fmtBusuanzi()}})</script><title>Spring Boot运行原理 - 半缘的小阁楼</title><noscript><link rel=stylesheet href=/css/noscript.css></noscript></head><body itemscope itemtype=http://schema.org/WebPage class=use-motion><div class=headband></div><main class=main><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-brand-container><div class=site-nav-toggle><div class=toggle aria-label role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div></div><div class=site-meta><a href=/ class=brand rel=start><i class=logo-line></i><h1 class=site-title>半缘的小阁楼</h1><i class=logo-line></i></a><p class=site-subtitle itemprop=description>举物而暗，无务博闻</p></div><div class=site-nav-right><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class=site-nav><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href=/ class=hvr-icon-pulse rel=section><i class="fa fa-home hvr-icon"></i>首页</a></li><li class="menu-item menu-item-about"><a href=/about/ class=hvr-icon-pulse rel=section><i class="fa fa-user hvr-icon"></i>关于</a></li><li class="menu-item menu-item-tech"><a href=/tech/ class=hvr-icon-pulse rel=section><i class="fa fa-swatchbook hvr-icon"></i>技术</a></li><li class="menu-item menu-item-record"><a href=/record/ class=hvr-icon-pulse rel=section><i class="fa fa-blog hvr-icon"></i>记录</a></li><li class="menu-item menu-item-archives"><a href=/ class=hvr-icon-pulse rel=section><i class="fa fa-archive hvr-icon"></i>归档
<span class=badge>4</span></a></li><li class="menu-item menu-item-commonweal"><a href=/404.html class=hvr-icon-pulse rel=section><i class="fa fa-heartbeat hvr-icon"></i>公益 404</a></li><li class="menu-item menu-item-search"><a role=button class="popup-trigger hvr-icon-pulse"><i class="fa fa-search fa-fw hvr-icon"></i>搜索</a></li></ul></nav><div class=search-pop-overlay><div class="popup search-popup"><div class=search-header><span class=search-icon><i class="fa fa-search"></i></span><div class=search-input-container><input autocomplete=off autocapitalize=off maxlength=80 placeholder=搜索... spellcheck=false type=search class=search-input></div><span class=popup-btn-close role=button><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class=search-result-icon><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></div><div class="toggle sidebar-toggle" role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div><aside class=sidebar><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class=sidebar-nav><li class=sidebar-nav-toc>文章目录</li><li class=sidebar-nav-overview>站点概览</li></ul><div class=sidebar-panel-container><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><nav id=TableOfContents><ul><li><ul><li><a href=#一springboot启动原理及相关流程概览>一、springboot启动原理及相关流程概览：</a></li><li><a href=#二springboot的启动类入口>二、springboot的启动类入口</a></li><li><a href=#三单单是springbootapplication接口用到了这些注解>三、单单是SpringBootApplication接口用到了这些注解</a><ul><li></li></ul></li><li><a href=#四springboot启动流程概览图>四、springboot启动流程概览图</a></li></ul></li><li><a href=#深入探索springapplication执行流程>深入探索SpringApplication执行流程</a><ul><li><ul><li></li></ul></li></ul></li></ul></nav></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image alt=半缘 src=/imgs/img-lazy-loading.gif data-src=/images/head_%e4%b8%a4%e5%8f%aa%e7%8c%ab.png><p class=site-author-name itemprop=name>半缘</p><div class=site-description itemprop=description>知识改变自己</div></div><div class="site-state-wrap site-overview-item animated"><nav class=site-state><div class="site-state-item site-state-posts"><a href=/archives/><span class=site-state-item-count>4</span>
<span class=site-state-item-name>日志</span></a></div><div class="site-state-item site-state-categories"><a href=/categories/><span class=site-state-item-count>0</span>
<span class=site-state-item-name>分类</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/><span class=site-state-item-count>0</span>
<span class=site-state-item-name>标签</span></a></div></nav></div><div class="links-of-social site-overview-item animated"><span class=links-of-social-item><a href=https://github.com/HistorySky title="Github → https://github.com/HistorySky" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-github fa-fw hvr-icon"></i>
Github</a></span></div><div class="cc-license animated" itemprop=license><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh class=cc-opacity rel=noopener target=_blank title=共享知识><img src=/imgs/img-lazy-loading.gif data-src=/imgs/cc/big/by_nc_sa.svg alt=共享知识></a></div></div></div></div><div id=siteinfo-card-widget class=sidebar-card-widget><div class=item-headline><i class="fas fa-chart-line"></i>
<span>网站资讯</span></div><div class=siteinfo><div class=siteinfo-item><div class=item-name><i class="fa-solid fa-calendar-check"></i>已运行：</div><div class=item-count id=runTimes data-publishdate=2020-09-27T20:18:54+03:00></div></div><div class=siteinfo-item><div class=item-name><i class="fas fa fa-user"></i>总访客数：</div><div class=item-count id=busuanzi_value_site_uv><i class="fa fa-sync fa-spin"></i></div></div><div class=siteinfo-item><div class=item-name><i class="fas fa fa-eye"></i>页面浏览：</div><div class=item-count id=busuanzi_value_site_pv><i class="fa fa-sync fa-spin"></i></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-font"></i>总字数：</div><div class=item-count id=wordsCount data-count=15378></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-mug-hot"></i>阅读约：</div><div class=item-count id=readTimes data-times=33></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-clock-rotate-left"></i>最后更新于：</div><div class=item-count id=last-push-date data-lastpushdate=2021-06-11T00:00:00+00:00></div></div></div></div></aside><div class=sidebar-dimmer></div></header><div class=tool-buttons><div id=goto-gtranslate class=button title=多语言翻译><i class="fas fa-globe"></i></div><div id=toggle-theme class=button title=深浅模式切换><i class="fas fa-adjust"></i></div><div class=back-to-top role=button title=返回顶部><i class="fa fa-arrow-up"></i>
<span>0%</span></div></div><div class=reading-progress-bar></div><a role=button class="book-mark-link book-mark-link-fixed"></a>
<a href=https://github.com/HistorySky rel="noopener external nofollow noreferrer" target=_blank title="Follow me on GitHub" class="exturl github-corner"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentcolor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4l13.9-13.8C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentcolor" class="octo-body"/></svg></a><script type=text/javascript src=//sidecar.gitter.im/dist/sidecar.v1.js async></script>
<script type=text/javascript>((window.gitter={}).chat={}).options={room:"hugo-next/community"}</script><noscript><div class=noscript-warning>Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class=post-block><article itemscope itemtype=http://schema.org/Article class=post-content lang><link itemprop=mainEntityOfPage href=https://historysky.github.io/tech/2020-11-30-springboot%E8%BF%90%E8%A1%8C%E5%8E%9F%E7%90%86/><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content="/images/head_两只猫.png"><meta itemprop=name content="孤言"></span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="半缘"><meta itemprop=description content="知识改变自己"></span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork><meta itemprop=name content="Spring Boot运行原理"><meta itemprop=description content="一、springboot启动原理及相关流程概览： springboot是基于spring的新型的轻量级框架，最厉害的地方当属**自动配置。**"></span><header class=post-header><h1 class=post-title itemprop="name headline">Spring Boot运行原理
<a href=https://github.com/user-name/repo-name/tree/branch-name/subdirectory-name/tech/2020-11-30-SpringBoot%e8%bf%90%e8%a1%8c%e5%8e%9f%e7%90%86.md rel="noopener external nofollow noreferrer" target=_blank class="exturl post-edit-link" title=编辑><i class="fa fa-pen-nib"></i></a></h1><div class=post-meta-container><div class=post-meta-items><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar"></i></span>
<span class=post-meta-item-text title=发表于>发表于：</span>
<time title="创建时间：2020-09-27 20:18:54 +0300 +0300" itemprop="dateCreated datePublished" datetime="2020-09-27 20:18:54 +0300 +0300">2020-09-27</time></span></div><div class=post-meta-items><span class=post-meta-item title=字数><span class=post-meta-item-icon><i class="far fa-file-word"></i></span>
<span class=post-meta-item-text>字数：</span>
<span>6121</span></span>
<span class=post-meta-item title=阅读><span class=post-meta-item-icon><i class="far fa-clock"></i></span>
<span class=post-meta-item-text>阅读：&ap;</span>
<span>13分钟</span></span>
<span class=post-meta-item title=浏览><span class=post-meta-item-icon><i class="far fa-eye"></i></span>
<span class=post-meta-item-text>浏览：</span>
<span id=busuanzi_value_page_pv data-path=/tech/2020-11-30-springboot%E8%BF%90%E8%A1%8C%E5%8E%9F%E7%90%86/><i class="fa fa-sync fa-spin"></i></span></span></div></div></header><div class="post-body autonumber" itemprop=articleBody><h3 id=一springboot启动原理及相关流程概览>一、springboot启动原理及相关流程概览：
<a class=header-anchor href=#%e4%b8%80springboot%e5%90%af%e5%8a%a8%e5%8e%9f%e7%90%86%e5%8f%8a%e7%9b%b8%e5%85%b3%e6%b5%81%e7%a8%8b%e6%a6%82%e8%a7%88></a></h3><p>springboot是基于spring的新型的轻量级框架，最厉害的地方当属**自动配置。**那我们就可以根据启动流程和相关原理来看看，如何实现传奇的自动配置</p><p><img src=/imgs/img-lazy-loading.gif data-src=../../assets/img/SpringBoot-Run/1.png alt></p><h3 id=二springboot的启动类入口>二、springboot的启动类入口
<a class=header-anchor href=#%e4%ba%8cspringboot%e7%9a%84%e5%90%af%e5%8a%a8%e7%b1%bb%e5%85%a5%e5%8f%a3></a></h3><p>　　用过springboot的技术人员很显而易见的两者之间的差别就是视觉上很直观的：springboot有自己独立的启动类（独立程序）</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@SpringBootApplication</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Application</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span><span style=color:#f92672>(</span>String<span style=color:#f92672>[]</span> args<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        SpringApplication<span style=color:#f92672>.</span><span style=color:#a6e22e>run</span><span style=color:#f92672>(</span>Application<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>,</span> args<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>从上面代码可以看出，Annotation定义（@SpringBootApplication）和类定义（SpringApplication.run）最为耀眼，所以要揭开SpringBoot的神秘面纱，我们要从这两位开始就可以了。</p><h3 id=三单单是springbootapplication接口用到了这些注解>三、单单是SpringBootApplication接口用到了这些注解
<a class=header-anchor href=#%e4%b8%89%e5%8d%95%e5%8d%95%e6%98%afspringbootapplication%e6%8e%a5%e5%8f%a3%e7%94%a8%e5%88%b0%e4%ba%86%e8%bf%99%e4%ba%9b%e6%b3%a8%e8%a7%a3></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Target</span><span style=color:#f92672>(</span>ElementType<span style=color:#f92672>.</span><span style=color:#a6e22e>TYPE</span><span style=color:#f92672>)</span> <span style=color:#75715e>// 注解的适用范围，其中TYPE用于描述类、接口（包括包注解类型）或enum声明
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>@Retention</span><span style=color:#f92672>(</span>RetentionPolicy<span style=color:#f92672>.</span><span style=color:#a6e22e>RUNTIME</span><span style=color:#f92672>)</span> <span style=color:#75715e>// 注解的生命周期，保留到class文件中（三个生命周期）
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>@Documented</span> <span style=color:#75715e>// 表明这个注解应该被javadoc记录
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>@Inherited</span> <span style=color:#75715e>// 子类可以继承该注解
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>@SpringBootConfiguration</span> <span style=color:#75715e>// 继承了Configuration，表示当前是注解类
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>@EnableAutoConfiguration</span> <span style=color:#75715e>// 开启springboot的注解功能，springboot的四大神器之一，其借助@import的帮助
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>@ComponentScan</span><span style=color:#f92672>(</span>excludeFilters <span style=color:#f92672>=</span> <span style=color:#f92672>{</span> <span style=color:#75715e>// 扫描路径设置（具体使用待确认）
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>@Filter</span><span style=color:#f92672>(</span>type <span style=color:#f92672>=</span> FilterType<span style=color:#f92672>.</span><span style=color:#a6e22e>CUSTOM</span><span style=color:#f92672>,</span> classes <span style=color:#f92672>=</span> TypeExcludeFilter<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>),</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Filter</span><span style=color:#f92672>(</span>type <span style=color:#f92672>=</span> FilterType<span style=color:#f92672>.</span><span style=color:#a6e22e>CUSTOM</span><span style=color:#f92672>,</span> classes <span style=color:#f92672>=</span> AutoConfigurationExcludeFilter<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>)</span> <span style=color:#f92672>})</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#a6e22e>@interface</span> SpringBootApplication <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>在其中比较重要的有三个注解，分别是：</p><p>1）@SpringBootConfiguration // 继承了Configuration，表示当前是注解类</p><p>2）@EnableAutoConfiguration // 开启springboot的注解功能，springboot的四大神器之一，其借助@import的帮助</p><p>3）@ComponentScan(excludeFilters = { // 扫描路径设置（具体使用待确认）</p><p>接下来对三个注解一一详解，增加对springbootApplication的理解</p><h6 id=1configuration注解>1）@Configuration注解
<a class=header-anchor href=#1configuration%e6%b3%a8%e8%a7%a3></a></h6><p>按照原来xml配置文件的形式，在springboot中我们大多用配置类来解决配置问题</p><p><strong>配置bean方式的不同：</strong>　</p><p>a）xml配置文件的形式配置bean</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#75715e>&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;beans</span> <span style=color:#a6e22e>xmlns=</span><span style=color:#e6db74>&#34;http://www.springframework.org/schema/beans&#34;</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>xmlns:xsi=</span><span style=color:#e6db74>&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>xsi:schemaLocation=</span><span style=color:#e6db74>&#34;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.0.xsd&#34;</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>default-lazy-init=</span><span style=color:#e6db74>&#34;true&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!--bean定义--&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/beans&gt;</span>
</span></span></code></pre></div><p>b）javaconfiguration的配置形式配置bean</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Configuration</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MockConfiguration</span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//bean定义
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p><strong>注入bean方式的不同</strong>：</p><p>a）xml配置文件的形式注入bean</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#f92672>&lt;bean</span> <span style=color:#a6e22e>id=</span><span style=color:#e6db74>&#34;mockService&#34;</span> <span style=color:#a6e22e>class=</span><span style=color:#e6db74>&#34;..MockServiceImpl&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/bean&gt;</span>
</span></span></code></pre></div><p>b）javaconfiguration的配置形式注入bean</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Configuration</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MockConfiguration</span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> MockService <span style=color:#a6e22e>mockService</span><span style=color:#f92672>(){</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> MockServiceImpl<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>任何一个标注了@Bean的方法，其返回值将作为一个bean定义注册到Spring的IoC容器，方法名将默认成该bean定义的id。</p><p><strong>表达bean之间依赖关系的不同：</strong></p><p>a）xml配置文件的形式表达依赖关系</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#f92672>&lt;bean</span> <span style=color:#a6e22e>id=</span><span style=color:#e6db74>&#34;mockService&#34;</span> <span style=color:#a6e22e>class=</span><span style=color:#e6db74>&#34;..MockServiceImpl&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>　　<span style=color:#f92672>&lt;propery</span> <span style=color:#a6e22e>name =</span><span style=color:#e6db74>&#34;dependencyService&#34;</span> <span style=color:#a6e22e>ref=</span><span style=color:#e6db74>&#34;dependencyService&#34;</span> <span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/bean&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;bean</span> <span style=color:#a6e22e>id=</span><span style=color:#e6db74>&#34;dependencyService&#34;</span> <span style=color:#a6e22e>class=</span><span style=color:#e6db74>&#34;DependencyServiceImpl&#34;</span><span style=color:#f92672>&gt;&lt;/bean&gt;</span>
</span></span></code></pre></div><p>b）javaconfiguration配置的形式表达依赖关系</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Configuration</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MockConfiguration</span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>public</span> MockService <span style=color:#a6e22e>mockService</span><span style=color:#f92672>(){</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> MockServiceImpl<span style=color:#f92672>(</span>dependencyService<span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>public</span> DependencyService <span style=color:#a6e22e>dependencyService</span><span style=color:#f92672>(){</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> DependencyServiceImpl<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>如果一个bean的定义依赖其他bean,则直接调用对应的JavaConfig类中依赖bean的创建方法就可以了。</p><h6 id=2-componentscan注解>2） @ComponentScan注解
<a class=header-anchor href=#2-componentscan%e6%b3%a8%e8%a7%a3></a></h6><p>作用：</p><ol><li>对应xml配置中的元素；</li><li>ComponentScan的功能其实就是自动扫描并加载符合条件的组件（比如@Component和@Repository等）或者bean定义;</li><li>将这些bean定义加载到IoC容器中.</li></ol><p>我们可以通过basePackages等属性来<strong>细粒度</strong>的定制@ComponentScan自动扫描的范围，如果不指定，则<strong>默认</strong>Spring框架实现会从声明@ComponentScan所在类的package进行扫描。</p><h6 id=3-enableautoconfiguration>3) <code>@EnableAutoConfiguration</code>
<a class=header-anchor href=#3-enableautoconfiguration></a></h6><p>此注解顾名思义是可以自动配置，所以应该是springboot中最为重要的注解。</p><p>在spring框架中就提供了各种以@Enable开头的注解，例如： @EnableScheduling、@EnableCaching、@EnableMBeanExport等； @EnableAutoConfiguration的理念和做事方式其实一脉相承简单概括一下就是，借助<code>@Import</code>的支持，收集和注册特定场景相关的bean定义。</p><ul><li>@EnableScheduling是通过@Import将Spring调度框架相关的bean定义都加载到IoC容器【定时任务、时间调度任务】</li><li>@EnableMBeanExport是通过@Import将JMX相关的bean定义加载到IoC容器【监控JVM运行时状态】</li></ul><p>@EnableAutoConfiguration也是借助@Import的帮助，将所有符合自动配置条件的bean定义加载到IoC容器。</p><p>@EnableAutoConfiguration作为一个复合Annotation,其自身定义关键信息如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@SuppressWarnings</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;deprecation&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Target</span><span style=color:#f92672>(</span>ElementType<span style=color:#f92672>.</span><span style=color:#a6e22e>TYPE</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Retention</span><span style=color:#f92672>(</span>RetentionPolicy<span style=color:#f92672>.</span><span style=color:#a6e22e>RUNTIME</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Documented</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Inherited</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@AutoConfigurationPackage</span><span style=color:#960050;background-color:#1e0010>【重点注解】</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Import</span><span style=color:#f92672>(</span>EnableAutoConfigurationImportSelector<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>)</span><span style=color:#960050;background-color:#1e0010>【重点注解】</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#a6e22e>@interface</span> EnableAutoConfiguration <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>其中最重要的两个注解已经标注：1、@AutoConfigurationPackage【重点注解】2、@Import(EnableAutoConfigurationImportSelector.class)【重点注解】</p><p>当然还有其中比较重要的一个类就是：EnableAutoConfigurationImportSelector.class</p><p><strong>AutoConfigurationPackage注解：</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Registrar</span> <span style=color:#66d9ef>implements</span> ImportBeanDefinitionRegistrar<span style=color:#f92672>,</span> DeterminableImports <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>registerBeanDefinitions</span><span style=color:#f92672>(</span>AnnotationMetadata metadata<span style=color:#f92672>,</span>BeanDefinitionRegistry registry<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>　　　　</span>register<span style=color:#f92672>(</span>registry<span style=color:#f92672>,</span> <span style=color:#66d9ef>new</span> PackageImport<span style=color:#f92672>(</span>metadata<span style=color:#f92672>).</span><span style=color:#a6e22e>getPackageName</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>它其实是注册了一个Bean的定义</p><p>new PackageImport(metadata).getPackageName()，它其实返回了当前主程序类的同级以及子级 的包组件</p><p><img src=/imgs/img-lazy-loading.gif data-src=../../assets/img/SpringBoot-Run/2.png alt></p><p>以上图为例，DemoApplication是和demo包同级，但是demo2这个类是DemoApplication的父级，和example包同级</p><p>也就是说，DemoApplication启动加载的Bean中，并不会加载demo2，这也就是为什么，我们要把DemoApplication放在项目的最高级中。</p><p><strong>Import(AutoConfigurationImportSelector.class)注解：</strong></p><p><img src=/imgs/img-lazy-loading.gif data-src=../../assets/img/SpringBoot-Run/3.png alt></p><p>可以从图中看出 AutoConfigurationImportSelector 继承了 DeferredImportSelector 继承了 ImportSelector</p><p>ImportSelector有一个方法为：selectImports。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> String<span style=color:#f92672>[]</span> <span style=color:#a6e22e>selectImports</span><span style=color:#f92672>(</span>AnnotationMetadata annotationMetadata<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>isEnabled<span style=color:#f92672>(</span>annotationMetadata<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> NO_IMPORTS<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>	AutoConfigurationMetadata autoConfigurationMetadata <span style=color:#f92672>=</span> AutoConfigurationMetadataLoader<span style=color:#f92672>.</span><span style=color:#a6e22e>loadMetadata</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>beanClassLoader</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>	AnnotationAttributes attributes <span style=color:#f92672>=</span> getAttributes<span style=color:#f92672>(</span>annotationMetadata<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>	List<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> configurations <span style=color:#f92672>=</span> getCandidateConfigurations<span style=color:#f92672>(</span>annotationMetadata<span style=color:#f92672>,</span>attributes<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>	configurations <span style=color:#f92672>=</span> removeDuplicates<span style=color:#f92672>(</span>configurations<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>	Set<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> exclusions <span style=color:#f92672>=</span> getExclusions<span style=color:#f92672>(</span>annotationMetadata<span style=color:#f92672>,</span> attributes<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>	checkExcludedClasses<span style=color:#f92672>(</span>configurations<span style=color:#f92672>,</span> exclusions<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>	configurations<span style=color:#f92672>.</span><span style=color:#a6e22e>removeAll</span><span style=color:#f92672>(</span>exclusions<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>	configurations <span style=color:#f92672>=</span> filter<span style=color:#f92672>(</span>configurations<span style=color:#f92672>,</span> autoConfigurationMetadata<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>	fireAutoConfigurationImportEvents<span style=color:#f92672>(</span>configurations<span style=color:#f92672>,</span> exclusions<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> StringUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>toStringArray</span><span style=color:#f92672>(</span>configurations<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>可以看到方法中，它其实是去加载 public static final String FACTORIES_RESOURCE_LOCATION = &ldquo;META-INF/spring.factories&rdquo;;外部文件。这个外部文件，有很多自动配置的类。如下：</p><p><img src=/imgs/img-lazy-loading.gif data-src=../../assets/img/SpringBoot-Run/4.png alt></p><p>其中，最关键的要属@Import(EnableAutoConfigurationImportSelector.class)，借助EnableAutoConfigurationImportSelector，@EnableAutoConfiguration可以帮助SpringBoot应用将所有符合条件的@Configuration配置都加载到当前SpringBoot创建并使用的IoC容器。就像一只“八爪鱼”一样。</p><p><img src=/imgs/img-lazy-loading.gif data-src=../../assets/img/SpringBoot-Run/5.png alt></p><h5 id=自动配置幕后英雄springfactoriesloader详解>自动配置幕后英雄：SpringFactoriesLoader详解
<a class=header-anchor href=#%e8%87%aa%e5%8a%a8%e9%85%8d%e7%bd%ae%e5%b9%95%e5%90%8e%e8%8b%b1%e9%9b%84springfactoriesloader%e8%af%a6%e8%a7%a3></a></h5><p>借助于Spring框架原有的一个工具类：SpringFactoriesLoader的支持，@EnableAutoConfiguration可以智能的自动配置功效才得以大功告成！</p><p>SpringFactoriesLoader属于Spring框架私有的一种扩展方案，其主要功能就是从指定的配置文件META-INF/spring.factories加载配置。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>abstract</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SpringFactoriesLoader</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>　　</span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> List<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>loadFactories</span><span style=color:#f92672>(</span>Class<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> factoryClass<span style=color:#f92672>,</span> ClassLoader classLoader<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>　　　　</span><span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>　　</span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>　　</span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> List<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>loadFactoryNames</span><span style=color:#f92672>(</span>Class<span style=color:#f92672>&lt;?&gt;</span> factoryClass<span style=color:#f92672>,</span> ClassLoader classLoader<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>　　　　</span><span style=color:#f92672>....</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>　　</span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>配合@EnableAutoConfiguration使用的话，它更多是提供一种配置查找的功能支持，即根据@EnableAutoConfiguration的完整类名org.springframework.boot.autoconfigure.EnableAutoConfiguration作为查找的Key,获取对应的一组@Configuration类</p><p><img src=/imgs/img-lazy-loading.gif data-src=../../assets/img/SpringBoot-Run/6.jpg alt></p><p>上图就是从SpringBoot的autoconfigure依赖包中的META-INF/spring.factories配置文件中摘录的一段内容，可以很好地说明问题。</p><p>所以，@EnableAutoConfiguration自动配置的魔法骑士就变成了：从classpath中搜寻所有的META-INF/spring.factories配置文件，并将其中org.springframework.boot.autoconfigure.EnableutoConfiguration对应的配置项通过反射（Java Refletion）实例化为对应的标注了@Configuration的JavaConfig形式的IoC容器配置类，然后汇总为一个并加载到IoC容器。</p><h3 id=四springboot启动流程概览图>四、springboot启动流程概览图
<a class=header-anchor href=#%e5%9b%9bspringboot%e5%90%af%e5%8a%a8%e6%b5%81%e7%a8%8b%e6%a6%82%e8%a7%88%e5%9b%be></a></h3><p><img src=/imgs/img-lazy-loading.gif data-src=../../assets/img/SpringBoot-Run/7.png alt></p><h2 id=深入探索springapplication执行流程>深入探索SpringApplication执行流程
<a class=header-anchor href=#%e6%b7%b1%e5%85%a5%e6%8e%a2%e7%b4%a2springapplication%e6%89%a7%e8%a1%8c%e6%b5%81%e7%a8%8b></a></h2><p>SpringApplication的run方法的实现是我们本次旅程的主要线路，该方法的主要流程大体可以归纳如下：</p><p>1） 如果我们使用的是SpringApplication的静态run方法，那么，这个方法里面首先要创建一个SpringApplication对象实例，然后调用这个创建好的SpringApplication的实例方法。在SpringApplication实例初始化的时候，它会提前做几件事情：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> ConfigurableApplicationContext <span style=color:#a6e22e>run</span><span style=color:#f92672>(</span>Object<span style=color:#f92672>[]</span> sources<span style=color:#f92672>,</span> String<span style=color:#f92672>[]</span> args<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> SpringApplication<span style=color:#f92672>(</span>sources<span style=color:#f92672>).</span><span style=color:#a6e22e>run</span><span style=color:#f92672>(</span>args<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><ul><li>根据classpath里面是否存在某个特征类（org.springframework.web.context.ConfigurableWebApplicationContext）来决定是否应该创建一个为Web应用使用的ApplicationContext类型。</li><li>使用SpringFactoriesLoader在应用的classpath中查找并加载所有可用的ApplicationContextInitializer。</li><li>使用SpringFactoriesLoader在应用的classpath中查找并加载所有可用的ApplicationListener。</li><li>推断并设置main方法的定义类。</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@SuppressWarnings</span><span style=color:#f92672>({</span> <span style=color:#e6db74>&#34;unchecked&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;rawtypes&#34;</span> <span style=color:#f92672>})</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>initialize</span><span style=color:#f92672>(</span>Object<span style=color:#f92672>[]</span> sources<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>sources <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> sources<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    	<span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>sources</span><span style=color:#f92672>.</span><span style=color:#a6e22e>addAll</span><span style=color:#f92672>(</span>Arrays<span style=color:#f92672>.</span><span style=color:#a6e22e>asList</span><span style=color:#f92672>(</span>sources<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>webEnvironment</span> <span style=color:#f92672>=</span> deduceWebEnvironment<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    setInitializers<span style=color:#f92672>((</span>Collection<span style=color:#f92672>)</span> getSpringFactoriesInstances<span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>    ApplicationContextInitializer<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>    setListeners<span style=color:#f92672>((</span>Collection<span style=color:#f92672>)</span> getSpringFactoriesInstances<span style=color:#f92672>(</span>ApplicationListener<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>mainApplicationClass</span> <span style=color:#f92672>=</span> deduceMainApplicationClass<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>2） SpringApplication实例初始化完成并且完成设置后，就开始执行run方法的逻辑了，方法执行伊始，首先遍历执行所有通过SpringFactoriesLoader可以查找到并加载的SpringApplicationRunListener。调用它们的started()方法，告诉这些SpringApplicationRunListener，“嘿，SpringBoot应用要开始执行咯！”。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> ConfigurableApplicationContext <span style=color:#a6e22e>run</span><span style=color:#f92672>(</span>String<span style=color:#f92672>...</span> args<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    StopWatch stopWatch <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> StopWatch<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    stopWatch<span style=color:#f92672>.</span><span style=color:#a6e22e>start</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    ConfigurableApplicationContext context <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    FailureAnalyzers analyzers <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    configureHeadlessProperty<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    SpringApplicationRunListeners listeners <span style=color:#f92672>=</span> getRunListeners<span style=color:#f92672>(</span>args<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    listeners<span style=color:#f92672>.</span><span style=color:#a6e22e>starting</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        ApplicationArguments applicationArguments <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> DefaultApplicationArguments<span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>                args<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        ConfigurableEnvironment environment <span style=color:#f92672>=</span> prepareEnvironment<span style=color:#f92672>(</span>listeners<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                applicationArguments<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        Banner printedBanner <span style=color:#f92672>=</span> printBanner<span style=color:#f92672>(</span>environment<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        context <span style=color:#f92672>=</span> createApplicationContext<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        analyzers <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> FailureAnalyzers<span style=color:#f92672>(</span>context<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        prepareContext<span style=color:#f92672>(</span>context<span style=color:#f92672>,</span> environment<span style=color:#f92672>,</span> listeners<span style=color:#f92672>,</span> applicationArguments<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                printedBanner<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>　　　　　</span><span style=color:#75715e>// 核心点：会打印springboot的启动标志，直到server.port端口启动
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        refreshContext<span style=color:#f92672>(</span>context<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        afterRefresh<span style=color:#f92672>(</span>context<span style=color:#f92672>,</span> applicationArguments<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        listeners<span style=color:#f92672>.</span><span style=color:#a6e22e>finished</span><span style=color:#f92672>(</span>context<span style=color:#f92672>,</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        stopWatch<span style=color:#f92672>.</span><span style=color:#a6e22e>stop</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>logStartupInfo</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>new</span> StartupInfoLogger<span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>mainApplicationClass</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>.</span><span style=color:#a6e22e>logStarted</span><span style=color:#f92672>(</span>getApplicationLog<span style=color:#f92672>(),</span> stopWatch<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> context<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>Throwable ex<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        handleRunFailure<span style=color:#f92672>(</span>context<span style=color:#f92672>,</span> listeners<span style=color:#f92672>,</span> analyzers<span style=color:#f92672>,</span> ex<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalStateException<span style=color:#f92672>(</span>ex<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>3） 创建并配置当前Spring Boot应用将要使用的Environment（包括配置要使用的PropertySource以及Profile）。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> ConfigurableEnvironment <span style=color:#a6e22e>prepareEnvironment</span><span style=color:#f92672>(</span>SpringApplicationRunListeners listeners<span style=color:#f92672>,</span>ApplicationArguments applicationArguments<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>　　</span><span style=color:#75715e>// Create and configure the environment
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>　　</span>ConfigurableEnvironment environment <span style=color:#f92672>=</span> getOrCreateEnvironment<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>　　</span>configureEnvironment<span style=color:#f92672>(</span>environment<span style=color:#f92672>,</span> applicationArguments<span style=color:#f92672>.</span><span style=color:#a6e22e>getSourceArgs</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>　　</span>listeners<span style=color:#f92672>.</span><span style=color:#a6e22e>environmentPrepared</span><span style=color:#f92672>(</span>environment<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>　　</span><span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>webEnvironment</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>　　　　</span>environment <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> EnvironmentConverter<span style=color:#f92672>(</span>getClassLoader<span style=color:#f92672>()).</span><span style=color:#a6e22e>convertToStandardEnvironmentIfNecessary</span><span style=color:#f92672>(</span>environment<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>　　</span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>　　</span><span style=color:#66d9ef>return</span> environment<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>4） 遍历调用所有SpringApplicationRunListener的environmentPrepared()的方法，告诉他们：“当前SpringBoot应用使用的Environment准备好了咯！”。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>environmentPrepared</span><span style=color:#f92672>(</span>ConfigurableEnvironment environment<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>　　</span><span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>SpringApplicationRunListener listener <span style=color:#f92672>:</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>listeners</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>　　　　</span>listener<span style=color:#f92672>.</span><span style=color:#a6e22e>environmentPrepared</span><span style=color:#f92672>(</span>environment<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>　　</span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>5） 如果SpringApplication的showBanner属性被设置为true，则打印banner。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> Banner <span style=color:#a6e22e>printBanner</span><span style=color:#f92672>(</span>ConfigurableEnvironment environment<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>　　</span><span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>bannerMode</span> <span style=color:#f92672>==</span> Banner<span style=color:#f92672>.</span><span style=color:#a6e22e>Mode</span><span style=color:#f92672>.</span><span style=color:#a6e22e>OFF</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>　　　　</span><span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>　　</span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>　　</span>ResourceLoader resourceLoader <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>resourceLoader</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>?</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>resourceLoader</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>new</span> DefaultResourceLoader<span style=color:#f92672>(</span>getClassLoader<span style=color:#f92672>());</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>　　</span>SpringApplicationBannerPrinter bannerPrinter <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> SpringApplicationBannerPrinter<span style=color:#f92672>(</span>resourceLoader<span style=color:#f92672>,</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>banner</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>　　</span><span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>bannerMode</span> <span style=color:#f92672>==</span> Mode<span style=color:#f92672>.</span><span style=color:#a6e22e>LOG</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>　　　　</span><span style=color:#66d9ef>return</span> bannerPrinter<span style=color:#f92672>.</span><span style=color:#a6e22e>print</span><span style=color:#f92672>(</span>environment<span style=color:#f92672>,</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>mainApplicationClass</span><span style=color:#f92672>,</span> logger<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>　　</span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>　　</span><span style=color:#66d9ef>return</span> bannerPrinter<span style=color:#f92672>.</span><span style=color:#a6e22e>print</span><span style=color:#f92672>(</span>environment<span style=color:#f92672>,</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>mainApplicationClass</span><span style=color:#f92672>,</span> System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>6） 根据用户是否明确设置了applicationContextClass类型以及初始化阶段的推断结果，决定该为当前SpringBoot应用创建什么类型的ApplicationContext并创建完成，然后根据条件决定是否添加ShutdownHook，决定是否使用自定义的BeanNameGenerator，决定是否使用自定义的ResourceLoader，当然，最重要的，将之前准备好的Environment设置给创建好的ApplicationContext使用。</p><p>7） ApplicationContext创建好之后，SpringApplication会再次借助Spring-FactoriesLoader，查找并加载classpath中所有可用的ApplicationContext-Initializer，然后遍历调用这些ApplicationContextInitializer的initialize（applicationContext）方法来对已经创建好的ApplicationContext进行进一步的处理。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@SuppressWarnings</span><span style=color:#f92672>({</span> <span style=color:#e6db74>&#34;rawtypes&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;unchecked&#34;</span> <span style=color:#f92672>})</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>applyInitializers</span><span style=color:#f92672>(</span>ConfigurableApplicationContext context<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>　　</span><span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>ApplicationContextInitializer initializer <span style=color:#f92672>:</span> getInitializers<span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>　　　　</span>Class<span style=color:#f92672>&lt;?&gt;</span> requiredType <span style=color:#f92672>=</span> GenericTypeResolver<span style=color:#f92672>.</span><span style=color:#a6e22e>resolveTypeArgument</span><span style=color:#f92672>(</span>initializer<span style=color:#f92672>.</span><span style=color:#a6e22e>getClass</span><span style=color:#f92672>(),</span> ApplicationContextInitializer<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>　　　　</span>Assert<span style=color:#f92672>.</span><span style=color:#a6e22e>isInstanceOf</span><span style=color:#f92672>(</span>requiredType<span style=color:#f92672>,</span> context<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;Unable to call initializer.&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>　　　　</span>initializer<span style=color:#f92672>.</span><span style=color:#a6e22e>initialize</span><span style=color:#f92672>(</span>context<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>　　</span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>8） 遍历调用所有SpringApplicationRunListener的contextPrepared()方法。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>prepareContext</span><span style=color:#f92672>(</span>ConfigurableApplicationContext context<span style=color:#f92672>,</span>ConfigurableEnvironment environment<span style=color:#f92672>,</span> SpringApplicationRunListeners listeners<span style=color:#f92672>,&lt;</span>br<span style=color:#f92672>&gt;</span>ApplicationArguments applicationArguments<span style=color:#f92672>,</span> Banner printedBanner<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>　　</span>context<span style=color:#f92672>.</span><span style=color:#a6e22e>setEnvironment</span><span style=color:#f92672>(</span>environment<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>　　</span>postProcessApplicationContext<span style=color:#f92672>(</span>context<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>　　</span>applyInitializers<span style=color:#f92672>(</span>context<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>　　</span>listeners<span style=color:#f92672>.</span><span style=color:#a6e22e>contextPrepared</span><span style=color:#f92672>(</span>context<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>　　</span><span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>logStartupInfo</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>　　　　</span>logStartupInfo<span style=color:#f92672>(</span>context<span style=color:#f92672>.</span><span style=color:#a6e22e>getParent</span><span style=color:#f92672>()</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>　　　　</span>logStartupProfileInfo<span style=color:#f92672>(</span>context<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>　　</span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Add boot specific singleton beans
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>　　</span>context<span style=color:#f92672>.</span><span style=color:#a6e22e>getBeanFactory</span><span style=color:#f92672>().</span><span style=color:#a6e22e>registerSingleton</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;springApplicationArguments&#34;</span><span style=color:#f92672>,</span>applicationArguments<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>　　</span><span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>printedBanner <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>　　　　</span>context<span style=color:#f92672>.</span><span style=color:#a6e22e>getBeanFactory</span><span style=color:#f92672>().</span><span style=color:#a6e22e>registerSingleton</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;springBootBanner&#34;</span><span style=color:#f92672>,</span> printedBanner<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>　　</span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Load the sources
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>　　</span>Set<span style=color:#f92672>&lt;</span>Object<span style=color:#f92672>&gt;</span> sources <span style=color:#f92672>=</span> getSources<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>　　</span>Assert<span style=color:#f92672>.</span><span style=color:#a6e22e>notEmpty</span><span style=color:#f92672>(</span>sources<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;Sources must not be empty&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>　　</span>load<span style=color:#f92672>(</span>context<span style=color:#f92672>,</span> sources<span style=color:#f92672>.</span><span style=color:#a6e22e>toArray</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> Object<span style=color:#f92672>[</span>sources<span style=color:#f92672>.</span><span style=color:#a6e22e>size</span><span style=color:#f92672>()]));</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>　　</span>listeners<span style=color:#f92672>.</span><span style=color:#a6e22e>contextLoaded</span><span style=color:#f92672>(</span>context<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>9)最核心的一步，将之前通过@EnableAutoConfiguration获取的所有配置以及其他形式的IoC容器配置加载到已经准备完毕的ApplicationContext。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>prepareAnalyzer</span><span style=color:#f92672>(</span>ConfigurableApplicationContext context<span style=color:#f92672>,</span>FailureAnalyzer analyzer<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>　　</span><span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>analyzer <span style=color:#66d9ef>instanceof</span> BeanFactoryAware<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>　　　　</span><span style=color:#f92672>((</span>BeanFactoryAware<span style=color:#f92672>)</span> analyzer<span style=color:#f92672>).</span><span style=color:#a6e22e>setBeanFactory</span><span style=color:#f92672>(</span>context<span style=color:#f92672>.</span><span style=color:#a6e22e>getBeanFactory</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>　　</span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>10） 遍历调用所有SpringApplicationRunListener的contextLoaded()方法。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>contextLoaded</span><span style=color:#f92672>(</span>ConfigurableApplicationContext context<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>　　</span><span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>SpringApplicationRunListener listener <span style=color:#f92672>:</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>listeners</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>　　　　</span>listener<span style=color:#f92672>.</span><span style=color:#a6e22e>contextLoaded</span><span style=color:#f92672>(</span>context<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>　　</span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><ol start=11><li>调用ApplicationContext的refresh()方法，完成IoC容器可用的最后一道工序。</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>refreshContext</span><span style=color:#f92672>(</span>ConfigurableApplicationContext context<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>　　</span>refresh<span style=color:#f92672>(</span>context<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>　　</span><span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>registerShutdownHook</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>　　</span><span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>　　　　</span>context<span style=color:#f92672>.</span><span style=color:#a6e22e>registerShutdownHook</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>　　</span><span style=color:#f92672>}</span><span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>AccessControlException ex<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>　　　　</span><span style=color:#75715e>// Not allowed in some environments.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>　　</span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>　　</span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>12） 查找当前ApplicationContext中是否注册有CommandLineRunner，如果有，则遍历执行它们。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>callRunners</span><span style=color:#f92672>(</span>ApplicationContext context<span style=color:#f92672>,</span> ApplicationArguments args<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>　　</span>List<span style=color:#f92672>&lt;</span>Object<span style=color:#f92672>&gt;</span> runners <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ArrayList<span style=color:#f92672>&lt;</span>Object<span style=color:#f92672>&gt;();</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>　　</span>runners<span style=color:#f92672>.</span><span style=color:#a6e22e>addAll</span><span style=color:#f92672>(</span>context<span style=color:#f92672>.</span><span style=color:#a6e22e>getBeansOfType</span><span style=color:#f92672>(</span>ApplicationRunner<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>).</span><span style=color:#a6e22e>values</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>　　</span>runners<span style=color:#f92672>.</span><span style=color:#a6e22e>addAll</span><span style=color:#f92672>(</span>context<span style=color:#f92672>.</span><span style=color:#a6e22e>getBeansOfType</span><span style=color:#f92672>(</span>CommandLineRunner<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>).</span><span style=color:#a6e22e>values</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>　　</span>AnnotationAwareOrderComparator<span style=color:#f92672>.</span><span style=color:#a6e22e>sort</span><span style=color:#f92672>(</span>runners<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>　　</span><span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>Object runner <span style=color:#f92672>:</span> <span style=color:#66d9ef>new</span> LinkedHashSet<span style=color:#f92672>&lt;</span>Object<span style=color:#f92672>&gt;(</span>runners<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>　　　　</span><span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>runner <span style=color:#66d9ef>instanceof</span> ApplicationRunner<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>　　　　　　</span>callRunner<span style=color:#f92672>((</span>ApplicationRunner<span style=color:#f92672>)</span> runner<span style=color:#f92672>,</span> args<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>　　　　</span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>　　　　</span><span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>runner <span style=color:#66d9ef>instanceof</span> CommandLineRunner<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>　　　　　　</span>callRunner<span style=color:#f92672>((</span>CommandLineRunner<span style=color:#f92672>)</span> runner<span style=color:#f92672>,</span> args<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>　　　　</span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>　　</span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>13）正常情况下，遍历执行SpringApplicationRunListener的finished()方法、（如果整个过程出现异常，则依然调用所有SpringApplicationRunListener的finished()方法，只不过这种情况下会将异常信息一并传入处理）</p><p>去除事件通知点后，整个流程如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>finished</span><span style=color:#f92672>(</span>ConfigurableApplicationContext context<span style=color:#f92672>,</span> Throwable exception<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>　　</span><span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>SpringApplicationRunListener listener <span style=color:#f92672>:</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>listeners</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>　　　</span>callFinishedListener<span style=color:#f92672>(</span>listener<span style=color:#f92672>,</span> context<span style=color:#f92672>,</span> exception<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>　　</span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p><img src=/imgs/img-lazy-loading.gif data-src=../../assets/img/SpringBoot-Run/8.png alt></p><h6 id=总结>总结
<a class=header-anchor href=#%e6%80%bb%e7%bb%93></a></h6><p>到此，SpringBoot的核心组件完成了基本的解析，综合来看，大部分都是Spring框架背后的一些概念和实践方式，SpringBoot只是在这些概念和实践上对特定的场景事先进行了固化和升华，而也恰恰是这些固化让我们开发基于Sping框架的应用更加方便高效。</p></div><footer class=post-footer><div class=addthis_inline_share_toolbox style=text-align:center></div><hr><div class=post-copyright><img src=/imgs/cc/cc.svg width=75 height=75 align=right alt=共享知识><ul><li class=post-copyright-title><strong>文章标题：</strong>
Spring Boot运行原理</li><li class=post-copyright-author><strong>原文作者：</strong>
孤言</li><li class=post-copyright-link><strong>本文链接：</strong>
<a id=post-cr-link href=https://historysky.github.io/tech/2020-11-30-springboot%E8%BF%90%E8%A1%8C%E5%8E%9F%E7%90%86/ title="Spring Boot运行原理">https://historysky.github.io/tech/2020-11-30-springboot%E8%BF%90%E8%A1%8C%E5%8E%9F%E7%90%86/</a></li><li class=post-copyright-license><strong>版权声明：</strong>
本博客所有文章除特别声明外，均采用 <i class="fab fa-fw fa-creative-commons"></i><a target=_blank href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div class=followme><span>欢迎关注我的其它发布渠道</span><div class=social-list><div class=social-item><a target=_blank class=social-link href=/rss.xml><span class=icon><i class="fa fa-rss"></i></span>
<span class=label>RSS</span></a></div></div></div><div class=post-nav><div class="post-nav-next post-nav-item"><a href=/tech/2020-12-13-sharding%E5%AE%9E%E7%8E%B0%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8/ rel=next title="Sharding JDBC实现分库分表"><i class="fa fa-chevron-left"></i> Sharding JDBC实现分库分表</a></div><div class="post-nav-prev post-nav-item"></div></div></footer></article></div></div></main><footer class=footer><div class=footer-inner><div id=gtranslate class=google-translate><i class="fa fa-language"></i><div id=google_translate_element></div></div><div class=copyright>&copy;
<span itemprop=copyrightYear>2021 - 2023</span>
<span class=with-love><i class="fa fa-heart"></i></span>
<span class=author itemprop=copyrightHolder>半缘</span></div><div class=powered-by>由 <a href=https://gohugo.io title=0.114.1 target=_blank>Hugo</a> & <a href=https://github.com/hugo-next/hugo-theme-next title=4.5.0 target=_blank>Hugo NexT.Gemini</a> 强力驱动</div></div></footer><script type=text/javascript src=https://cdn.staticfile.org/animejs/3.2.1/anime.min.js defer></script>
<script type=text/javascript src=https://cdn.staticfile.org/viewerjs/1.11.0/viewer.min.js defer></script>
<script class=next-config data-name=main type=application/json>{"bookmark":{"color":"#222","enable":true,"save":"manual"},"copybtn":true,"darkmode":true,"giscus":{"cfg":{"category":"Comments","categoryid":null,"emit":false,"inputposition":"top","mapping":"title","reactions":false,"repo":"username/repo-name","repoid":null,"theme":"preferred_color_scheme"},"js":"https://giscus.app/client.js"},"hostname":"https://historysky.github.io/","i18n":{"ds_day":" 天前","ds_days":" 天 ","ds_hour":" 小时前","ds_hours":" 小时 ","ds_just":"刚刚","ds_min":" 分钟前","ds_mins":" 分钟","ds_month":" 个月前","ds_years":" 年 ","empty":"没有找到任何搜索结果：${query}","hits":"找到 ${hits} 个搜索结果","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","placeholder":"搜索..."},"lang":"zh-CN","lazyload":false,"localSearch":{"enable":true,"path":"/searchindexes.xml","preload":false,"topnperarticle":-1,"trigger":"auto","unescape":false},"motion":{"async":true,"enable":true,"transition":{"collheader":"fadeInLeft","postblock":"fadeIn","postbody":"fadeInDown","postheader":"fadeInDown","sidebar":"fadeInUp"}},"postmeta":{"comments":{"enable":true,"plugin":"waline"},"views":{"enable":true,"plugin":"busuanzi"}},"root":"/","scheme":"Gemini","sidebar":{"display":"post","offset":12,"padding":18,"position":"left","width":256},"vendor":{"plugins":"qiniu","router":"https://cdn.staticfile.org"},"version":"4.5.0","waline":{"cfg":{"comment":true,"emoji":false,"imguploader":false,"pageview":true,"placeholder":"请文明发言哟 ヾ(≧▽≦*)o","reaction":true,"reactiontext":["点赞","踩一下","得意","不屑","尴尬","睡觉"],"reactiontitle":"你认为这篇文章怎么样？","requiredmeta":["nick","mail"],"serverurl":null,"sofa":"快来发表你的意见吧 (≧∀≦)ゞ","wordlimit":200},"css":{"alias":"waline","file":"dist/waline.css","name":"@waline/client","version":"2.13.0"},"js":{"alias":"waline","file":"dist/waline.js","name":"@waline/client","version":"2.13.0"}}}</script><script type=text/javascript src=/js/main.min.0fb3547374c917d23a2e5f762b70f3698d20b46a01cc18c38f9c467aeffc99fc.js defer></script></body></html>